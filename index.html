<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Cocktail Compendium</title>
	<link rel="stylesheet" type="text/css" href="styles.css" media="screen" />
</head>
<body>

	<div class="upperContainer">
		<h2>Cocktail Compendium</h2>

		<div class="inputContainer">
			<div class="inputsColumn">
				<input
					id="ingredient-0"
					onkeyup="onInputChange(this, event)"
					onfocus="clearSuggestions()"
					type="text"
					placeholder="Ingredient"
				/>
				<input
					id="ingredient-1"
					onkeyup="onInputChange(this, event)"
					onfocus="clearSuggestions()"
					type="text"
					placeholder="Ingredient"
				/>
				<input
					id="ingredient-2"
					onkeyup="onInputChange(this, event)"
					onfocus="clearSuggestions()"
					type="text"
					placeholder="Ingredient"
				/>
				<input
					id="ingredient-3"
					onkeyup="onInputChange(this, event)"
					onfocus="clearSuggestions()"
					type="text"
					placeholder="Ingredient"
				/>
				<input
					id="ingredient-4"
					onkeyup="onInputChange(this, event)"
					onfocus="clearSuggestions()"
					type="text"
					placeholder="Ingredient"
				/>

				<button id="submit" class="submitBtn">Find</button>
			</div>

			<div id="suggestions" class="suggestionsColumn"></div>
		</div>
	</div>

	<div id="results" class="results"></div>

	<script type="text/javascript" src="recipes.js"></script>
	<script type="text/javascript" src="utils.js"></script>
	<script type="text/javascript">
		console.log(recipes.length);

		var allTokens = recipes.map((recipe) =>
			recipe.ingredients.map((ingredient) =>
				ingredient.split(" ")
			).flat()
		)
		.flat()
		.filter((token) => !token.match(/^[\d\.]/))
		.filter((token) => token !== "oz")
		.map((token) => token.toLowerCase());

		var allTokensSet = new Set(allTokens);
		var ingredientTokens = Array.from(allTokensSet);

		var suggestionsContainer = document.getElementById("suggestions");
		function clearSuggestions() {
			suggestionsContainer.innerHTML = "";
		}

		var submitBtn = document.getElementById("submit");
		function onInputChange(input, event) {
			if (event.keyCode === 13) {
				event.preventDefault();
				submitBtn.click();
			}
			var inputValue = input.value;
			if (inputValue.length > 1) {
				clearSuggestions();
				var matchingTokens = ingredientTokens.filter((token) =>
					token.startsWith(inputValue.toLowerCase())
				).slice(0, 8);
				matchingTokens.forEach((matchingToken) => {
					var suggestion = document.createElement("button");
					suggestion.onclick = () => { input.value = matchingToken };
					suggestion.className = "suggestion";
					suggestion.innerHTML = "<span>" + matchingToken + "<span>"
						+ "<span class='addSuggestion'> &#8592; </span>";
					suggestionsContainer.appendChild(suggestion);
				});
			}
		}

		submitBtn.onclick = function() {
			var matches = [...recipes];
			for (var i = 0; i < 5; i++) {
				var searchIngredient = document.getElementById("ingredient-" + i).value;
				if (searchIngredient) {
					var lookupRegex = new RegExp("\\b" + searchIngredient + "\\b", "i");
					matches = matches.filter((recipe) =>
						recipe.ingredients.some((ingredient) =>
							lookupRegex.test(ingredient)
						)
					);
				}
			}

			var resultContainer = document.getElementById("results");

			if (matches.length == 0) {
				resultContainer.innerHTML = "<h3>No matches</h3>";
			} else {
				matches
					.sort(() => Math.random() - 0.5)
					.forEach((recipe) => {
						var matchContainer = document.createElement('div');
						matchContainer.className = "match";
						matchContainer.innerHTML += "<h3>" + recipe.name.toUpperCase() + "</h3>";
						recipe.ingredients.forEach((ingredient) => {
							var formattedIngredient = getFormattedIngredient(ingredient);
							matchContainer.appendChild(formattedIngredient);
						});
						matchContainer.innerHTML += "<div class='procedure'>" + recipe.procedure + "</div>";
						resultContainer.appendChild(matchContainer);
					});
			}
		};

	</script>
</body>
</html>
